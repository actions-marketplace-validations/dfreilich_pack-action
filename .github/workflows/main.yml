name: test

on: [push]

env:
  TEST_APP_PATH: ".github/workflows/test-app"
  BUILDER: "paketobuildpacks/builder:tiny"

jobs:
  help:
    runs-on: ubuntu-latest
    name: Pack Help
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Pack Help
        uses: ./
        with:
          args: 'help'
  version:
    runs-on: ubuntu-latest
    name: Pack Version
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Pack Version
        uses: ./
        with:
          args: 'version'
  local_build:
    runs-on: ubuntu-latest
    name: Pack Local Build
    steps:
      - name: Checkout Action
        uses: actions/checkout@v2
      - name: Run local registry
        run: docker run -d -p 5000:5000 --name registry registry:2
      - name: Pack Build
        uses: ./
        with:
          args: 'build localhost:5000/test --builder ${{ env.BUILDER }} --path ${{ env.TEST_APP_PATH }}'
      - name: Test App
        run: |
          docker run -d -p 8080:8080 --name testapp localhost:5000/test
          curl localhost:8080
      - name: Clean Up
        run: |
          docker container stop testapp
          docker container stop registry
  remote_build:
    runs-on: ubuntu-latest
    name: Pack Remote Build
    steps:
      - name: Checkout Action
        uses: actions/checkout@v2
      - name: Pack Build
        uses: ./
        with:
          args: 'build localhost:5000/test --builder ${{ env.BUILDER }} --path ${{ env.TEST_APP_PATH }}'
      - name: Test App
        run: |
          docker run -d -p 8080:8080 --name testapp localhost:5000/test
          curl localhost:8080
      - name: Clean Up
        run: |
          docker container stop testapp
          docker container stop registry
